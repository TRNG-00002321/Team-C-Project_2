pipeline {
    agent {
        docker {
            image 'maven:3.9-eclipse-temurin-17'
            args '-v maven-repo:/root/.m2'
        }
    }


    environment {
        // Application image name
        APP_NAME = 'expense-manager'
        APP_PORT = '5001'

        // AWS EC2 deployment target
//         EC2_HOST = credentials('ec2-deploy-host')
//         EC2_USER = 'ec2-user'

        // Build version
        BUILD_VERSION = "${BUILD_NUMBER}"

        // Docker-in-Docker: Host workspace path
        // When Jenkins runs in a container, Docker daemon needs the HOST path
        // Set JENKINS_HOME_HOST in Jenkins container env (e.g., /home/ec2-user/jenkins_home)
        WORKSPACE_HOST = "${env.JENKINS_HOME_HOST ?: env.JENKINS_HOME}/workspace/${env.JOB_NAME}"
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timestamps()
        timeout(time: 45, unit: 'MINUTES')
    }

    stages {
        stage("Validate"){
            steps{
                echo "${WORKSPACE_HOST}"
            }
        }
        stage('Checkout') {
            steps {
                echo 'checkout step'
                checkout scm
                script {
                    env.GIT_COMMIT_SHORT = sh(
                        script: 'git rev-parse --short HEAD',
                        returnStdout: true
                    ).trim()
                    echo "Building commit: ${env.GIT_COMMIT_SHORT}"
                }
            }
        }
        stage('Build') {
            steps {
                dir('manager') {
                    sh 'mvn clean compile -B'
                }
            }
        }

        stage('Unit Tests') {
            steps {
                dir('manager'){
                //todo: only run unit tests!
                    echo 'skipping tests for now:'
//                     sh 'mvn test -B'
                }
            }
            post {
                always {
                    dir('manager'){
                        junit allowEmptyResults: true, testResults: 'target/surefire-reports/*.xml'
                    }
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                dir('manager'){
                    echo 'Building Java Manager Application...'
                    sh  '''
                        docker build \
                        -t ${APP_NAME}:${BUILD_VERSION} \
                        -t ${APP_NAME}:latest \
                        -f Dockerfile .
                        '''
                }

           }
        }
        stage('Tests Tests') {
            steps {
                dir('manager'){
                //todo: only run unit tests!
                    echo 'lumping tests together for now:'
                     sh 'mvn test -B'
                }
            }
            post {
                always {
                    dir('manager'){
                        junit allowEmptyResults: true, testResults: 'target/surefire-reports/*.xml'
                    }
                }
            }
        }

//
//         stage('Start Application') {
//             steps {
//                 echo 'ðŸš€ Starting Manager App for API/E2E Testing...'
//                 sh '''
//                     # Stop any existing container
//                     docker stop ${APP_NAME}-test || true
//                     docker rm ${APP_NAME}-test || true
//
//                     # Start the container
//                     docker run -d \
//                         --name ${APP_NAME}-test \
//                         -p ${APP_PORT}:${APP_PORT} \
//                         -v expense-data:/data \
//                         ${APP_NAME}:${BUILD_VERSION}
//
//                     # Wait for app to be healthy
//                     echo "Waiting for application to start..."
//                     sleep 30
//                     curl -f http://localhost:${APP_PORT}/health || exit 1
//                     echo "âœ… Application is ready!"
//                 '''
//             }
//         }

        post {
            always {
                echo 'ðŸ§¹ Cleaning up...'
                sh '''
                    docker stop ${APP_NAME}-test || true
                    docker rm ${APP_NAME}-test || true
                    docker rmi ${APP_NAME}:${BUILD_VERSION} || true
                '''

                archiveArtifacts artifacts: '''
                    target/surefire-reports/**/*.xml,
                ''', allowEmptyArchive: true
            }
        }



    }

//pipeline end
}