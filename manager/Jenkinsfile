pipeline {
    agent any
    tools {
            maven 'maven-3'
        }

    environment {
        // Application image name
        APP_NAME = 'manager_app'
        APP_PORT = '5001'

        // AWS EC2 deployment target
//         EC2_HOST = credentials('ec2-deploy-host')
//         EC2_USER = 'ec2-user'

        // Build version
        BUILD_VERSION = "${BUILD_NUMBER}"

        // Docker-in-Docker: Host workspace path
        // When Jenkins runs in a container, Docker daemon needs the HOST path
        // Set JENKINS_HOME_HOST in Jenkins container env (e.g., /home/ec2-user/jenkins_home)
        WORKSPACE_HOST = "${env.JENKINS_HOME_HOST ?: env.JENKINS_HOME}/workspace/${env.JOB_NAME}"

        DOCKER_IMAGE = "manager_app"
        BUILD_DOCKER = true
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timestamps()
        timeout(time: 45, unit: 'MINUTES')
    }

    stages {
        stage("Validate"){
            steps{
                echo "${WORKSPACE_HOST}"
            }
        }
        stage('Checkout') {
            steps {
                echo 'checkout step'
                checkout scm
                script {
                    env.GIT_COMMIT_SHORT = sh(
                        script: 'git rev-parse --short HEAD',
                        returnStdout: true
                    ).trim()
                    echo "Building commit: ${env.GIT_COMMIT_SHORT}"
                }
            }
        }
        stage('Build') {
            steps {
                dir('manager') {
                    sh 'mvn clean compile -B'
                }
            }
        }
        stage('Setup network') {
                    steps {
                        script {
                            // Create a Docker network if it doesn't already exist
                            sh '''
                                docker network inspect man-test >/dev/null 2>&1 || \
                                docker network create man-test
                            '''
                        }
                    }
                }

        stage('Unit Tests') {

            steps {
                dir('manager'){
                //todo: only run unit tests!
                    echo 'skipping tests for now:'
//                     sh 'mvn test -B'
                }
            }
            post {
                always {
                    dir('manager'){
                        junit allowEmptyResults: true, testResults: 'target/surefire-reports/*.xml'
                    }
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                echo 'Building Java Manager Application...'
                    sh '''
                        docker build -f ./manager/Dockerfile -t ${DOCKER_IMAGE}:${BUILD_NUMBER} .
                        docker tag ${DOCKER_IMAGE}:${BUILD_NUMBER} ${DOCKER_IMAGE}:latest
                    '''

           }
        }



        stage('Start Application') {
            steps {
                echo 'ðŸš€ Starting Manager App for API/E2E Testing...'
                sh '''
                    # Stop any existing container
                    docker stop ${APP_NAME} || true
                    docker rm ${APP_NAME} || true

                    # Start the container
                    docker run -d \
                        --name ${APP_NAME} \
                        --network man-test \
                        -p ${APP_PORT}:${APP_PORT} \
                        -v expense-data:/data \
                        ${APP_NAME}:${BUILD_VERSION}
                '''
                sh '''
                    # Wait for app to be healthy
                    echo "Waiting for application to start..."
                    sleep 5
                    # curl -v http://${APP_NAME}:8080
                    # curl -f http://localhost:5001/health
                    RESPONSE_CODE=\$(curl -f http://${APP_NAME}:${APP_PORT}/health)
                    echo "Health check response code: \$RESPONSE_CODE"
                                        if [ "\$RESPONSE_CODE" -ne 200 ]; then
                                            exit 1
                                        fi
                    echo "âœ… Application is ready!"
                '''

            }
        }
            stage('Tests Tests') {
                steps {
                    dir('manager'){
                    //todo: only run unit tests!
                        echo 'lumping tests together for now:'
                         sh 'mvn test -B'
                    }
                }
                post {
                    always {
                        dir('manager'){
                            junit allowEmptyResults: true, testResults: 'target/surefire-reports/*.xml'
                        }
                    }
                }
            }
    }

    post {
        always {
            echo 'ðŸ§¹ Cleaning up...'
            sh '''
                docker stop ${APP_NAME}-test || true
                docker rm ${APP_NAME}-test || true
                docker rmi ${APP_NAME}:${BUILD_VERSION} || true
            '''

            archiveArtifacts artifacts: '''
                target/surefire-reports/**/*.xml,
                ''', allowEmptyArchive: true
        }
    }

//pipeline end
}