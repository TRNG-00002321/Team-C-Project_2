pipeline {
    agent any

    environment {
        // Application image name
        APP_NAME = 'expense-manager'
        APP_PORT = '5001'

        // AWS EC2 deployment target
//         EC2_HOST = credentials('ec2-deploy-host')
//         EC2_USER = 'ec2-user'

        // Build version
        BUILD_VERSION = "${BUILD_NUMBER}"

        // Docker-in-Docker: Host workspace path
        // When Jenkins runs in a container, Docker daemon needs the HOST path
        // Set JENKINS_HOME_HOST in Jenkins container env (e.g., /home/ec2-user/jenkins_home)
        WORKSPACE_HOST = "${env.JENKINS_HOME_HOST ?: env.JENKINS_HOME}/workspace/${env.JOB_NAME}"
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timestamps()
        timeout(time: 45, unit: 'MINUTES')
    }

    stages {
        stage('Checkout') {
            steps {
                echo 'checkout step'
                script {
                    env.GIT_COMMIT_SHORT = sh(
                        script: 'git rev-parse --short HEAD',
                        returnStdout: true
                    ).trim()
                    echo "Building commit: ${env.GIT_COMMIT_SHORT}"
                }
            }
        }
        stage('Unit Tests') {
                    steps {
                        echo 'ðŸ§ª Running Java Unit Tests with Allure...'
                        sh '''
                            docker run --rm \
                                -v ${WORKSPACE_HOST}:./ \
                                -v maven-repo:/root/.m2 \
                                -w ./ \
                                maven:3.9-eclipse-temurin-17 \
                                mvn clean test \
                                -Dtest="**/unit/**" \
                                -B
                        '''
                    }
                    post {
                        always {
                            junit allowEmptyResults: true, testResults: 'target/surefire-reports/*.xml'
                        }
                    }
                }
    }

//pipeline end
}